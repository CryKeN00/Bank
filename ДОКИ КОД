namespace Банк1
{
    internal class Program
    {
        /// <summary>
        /// В классе Main создаются объекты и константы, потоки, а так же генератор случайных чисел для установки пополнения счета
        /// </summary>
        static void Main(string[] args)
        {
            var account = new BankAccount(); //Создание объекта класс BankAccount для управления балансом
            int rAmount = 100; //Сумма нужная для снятия денег со счета.
            var depositThread = new Thread(() => //Создание потока для пополнения счета
            {
                var random = new Random(); //Генерация случайных чисел
                ///<remarks>
                ///В методе Popolnenie можно поменять значения и указать количество денег, которое будет поступать на счет
                ///</remarks>
                ///<example>
                ///Если ввести значения, например, 10 и 60
                ///То, пополнение будет происходить в промежутке от 10 до 60
                ///</example>
                for (int i = 0; i < 3; i++) //Пополняем баланс 3 раза на 3 рандомные суммы
                {
                    {
                        account.Popolnenie(random.Next(5, 30)); //Вызов метода с пополнением счета
                        Thread.Sleep(1000); //Приостановка выполнения потока на 1 секунду
                    }
                }
            }); 
            ///<summary>
            ///В данном блоке происходит ожидание нужного для снятия денег баланска, а также запуск потока
            ///</summary>
            depositThread.Start(); //Запуск потока
            account.WaitBalance(rAmount);  //Ожидание нужного для снятия денег баланса
            if (account.TryWithdraw(rAmount))  //Попытка снятия средств
            {
                Console.WriteLine($"Остаток баланса: " + account.balance);
            }
        }
    }
    /// <summary>
    /// Создание класса для создания банковского счета
    /// </summary>
    class BankAccount //Создание класса для создания банковского счета
    {
        public int balance; //Баланс
        private readonly object balanceLock = new(); //Объект для блокировки доступа к полю баланса

        public BankAccount() //Конструктор
        {
            this.balance = 0;
        }
        /// <summary>
        /// Метод для пополнения счета
        /// </summary>
        /// <param name="amount">
        /// Этот параметр указывает на переменную с балансом
        /// </param>
        public void Popolnenie(int amount) //Метод для пополнения счета
        {
            lock (balanceLock) //Использование блокировки для безопасного доступа к балансу из разных потоков
            {
                balance += amount; //Увеличение баланса на пополненную сумму
                Console.WriteLine($"Пополнение: {amount:C}, Ваш баланс: {balance:C}"); 
            }
        }
        /// <summary>
        /// Метод ожидания нужного для снятия средств баланса
        /// </summary>
        /// <param name="rAmount">
        /// Данный параметр показывает сколько нужно денег для снятия денег со счета
        /// </param>
        public void WaitBalance(int rAmount) //Метод ожидания нужного для снятия средств баланса
        {
            while (true) //Бесконечный цикл, который закончится, как только метод вернется
            {
                lock (balanceLock) //Использование блокировки для безопасного доступа к балансу из разных потоков
                {
                    if (balance >= rAmount) //Проверяем, достаточно ли средств для снятия
                    {
                        Console.WriteLine("У вас достаточно денег для снятия");
                        return;
                    }
                }
                Thread.Sleep(300); //Приостановка потока, если средств недостаточно
            }
        }
        /// <summary>
        /// Метод попытки снятия денег со счета
        /// </summary>
        /// <param name="amount">
        /// Снова параметр указывает сколько денег на счете
        /// </param>
        /// <returns>
        /// true если снятие прошло успешно, //false если неуспешно
        /// </returns>
        public bool TryWithdraw(int amount) //Метод для попытки снятия
        {
            lock (balanceLock) //Использование блокировки для безопасного доступа к балансу из разных потоков
            {
                if (balance >= amount) //Проверка, достаточно ли средств для снятия
                {
                    balance -= amount; //Вычитание из баланса снятой суммы
                    Console.WriteLine($"Снятие средств:{amount:C}, Ваш баланс:{balance:C}");
                    return true; //true если снятие прошло успешно
                }
                Console.WriteLine("У вас недостаточно средств для снятия данной суммы.");
                return false; //false если неуспешно
            }
        }
    }
}
